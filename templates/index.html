{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Credit Point Management</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --accent:#22c55e; --danger:#ef4444; --border:#1f2937; --text:#e5e7eb; --card:#0b1220; }
    *{box-sizing:border-box;}
    body{margin:0;font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);}
    header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(15,23,42,0.95);backdrop-filter:blur(6px);z-index:10;}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(34,197,94,0.12);color:#86efac;font-weight:600;font-size:13px;border:1px solid rgba(34,197,94,0.3);}
    .container{padding:18px;max-width:960px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:12px;}
    h1{margin:0;font-size:24px;font-weight:700;letter-spacing:-0.01em;}
    h2{margin:0 0 8px;font-size:16px;font-weight:600;}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 16px 40px rgba(0,0,0,0.35);}
    .panel + .panel{margin-top:6px;}
    .list{display:flex;flex-direction:column;gap:8px;margin:0;padding:0;list-style:none;}
    .item{padding:12px;border:1px solid var(--border);border-radius:10px;background:var(--card);display:flex;gap:10px;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;}
    .muted{color:var(--muted);font-size:13px;}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600;}
    .pill.success{background:rgba(34,197,94,0.15);color:#bbf7d0;border:1px solid rgba(34,197,94,0.35);}
    .pill.warn{background:rgba(234,179,8,0.15);color:#facc15;border:1px solid rgba(234,179,8,0.35);}
    .pill.danger{background:rgba(239,68,68,0.15);color:#fecdd3;border:1px solid rgba(239,68,68,0.35);}
    form{display:flex;flex-direction:column;gap:10px;margin-top:8px;}
    input, textarea, select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text);font:inherit;}
    input:focus, textarea:focus, select:focus{outline:2px solid rgba(34,197,94,0.4);}
    button{padding:10px 14px;border:none;border-radius:10px;font-weight:600;cursor:pointer;color:#0b1220;background:var(--accent);transition:transform 0.08s ease,box-shadow 0.2s ease;}
    button.secondary{background:#1f2937;color:#e5e7eb;border:1px solid var(--border);}
    button:hover{transform:translateY(-1px);box-shadow:0 10px 30px rgba(34,197,94,0.25);}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;}
    .stat{padding:10px;border:1px solid var(--border);border-radius:10px;background:linear-gradient(135deg,rgba(34,197,94,0.12),rgba(34,197,94,0.04));}
    .stat strong{display:block;font-size:20px;margin-top:3px;}
    .empty{padding:10px;border:1px dashed var(--border);border-radius:10px;color:var(--muted);text-align:center;}
    .toast{position:fixed;bottom:20px;right:20px;background:#111827;border:1px solid var(--border);padding:12px 16px;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,0.45);display:none;}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="badge">Credit Point Management</div>
      <h1>Household Tasks & Points</h1>
      <div class="muted">Track tasks, credit points, and assignments in one place.</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;font-weight:700;color:#cbd5e1;">
          {{ request.user.username|slice:":1"|upper }}
        </div>
        <div class="muted">{{ request.user.username }}</div>
      </div>
      <a href="/accounts/logout/">
        <button type="button" class="secondary">Logout</button>
      </a>
    </div>
  </header>

  <main class="container">
    <section class="panel">
      <h2>Overview</h2>
      <div class="grid" id="stats">
        <div class="stat"><span class="muted">Tasks</span><strong id="stat-tasks">-</strong></div>
        <div class="stat"><span class="muted">My Points</span><strong id="stat-points">-</strong></div>
      </div>
    </section>

    <section class="panel">
      <h2>My Dashboard</h2>
      <div class="grid">
        <div class="stat"><span class="muted">Total Tasks</span><strong id="dash-total">-</strong></div>
        <div class="stat"><span class="muted">Pending</span><strong id="dash-pending">-</strong></div>
        <div class="stat"><span class="muted">Awaiting Approval</span><strong id="dash-awaiting">-</strong></div>
        <div class="stat"><span class="muted">Awaiting Points</span><strong id="dash-awaiting-points">-</strong></div>
        <div class="stat"><span class="muted">My Points</span><strong id="dash-my-points">-</strong></div>
      </div>
    </section>

    <section class="panel">
      <h2>Tasks</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px;flex-wrap:wrap;">
        <span class="muted">View tasks for:</span>
        <select id="user-filter" style="max-width:220px;">
          <option value="" selected>Select user</option>
        </select>
      </div>
      <ul class="list" id="task-list"></ul>
      <div class="muted" style="margin-top:6px;text-align:right;">
        Total approved points: <strong id="task-total-points">0</strong>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>
  <form style="display:none">{% csrf_token %}</form>

  <script>
    const apiBase = "/api";
    const IS_STAFF = "{{ request.user.is_staff|yesno:'true,false' }}" === "true";
    const CURRENT_USER_ID = Number("{{ request.user.id }}");
    const toastEl = document.getElementById("toast");
    const getCookie = (name) => {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
    };
    const csrftoken = getCookie("csrftoken");
    const showToast = (msg, isError=false) => {
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      toastEl.style.borderColor = isError ? "rgba(239,68,68,0.5)" : "rgba(34,197,94,0.5)";
      toastEl.style.color = isError ? "#fecdd3" : "#bbf7d0";
      setTimeout(() => toastEl.style.display = "none", 3000);
    };

    async function api(url, options={}) {
      const opts = {
        headers: {
          "Content-Type": "application/json",
          ...(csrftoken ? {"X-CSRFToken": csrftoken} : {})
        },
        ...options
      };
      const res = await fetch(url, opts);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || res.statusText);
      }
      return res.json();
    }

    async function loadTasks() {
      let url = `${apiBase}/tasks/`;
      const select = document.getElementById("user-filter");
      const val = select ? select.value : "";
      if (val) {
        url += `?assigned_to=${val}`;
      }
      const data = await api(url);
      const list = document.getElementById("task-list");
      list.innerHTML = "";
      let myApprovedPoints = 0;
      let awaitingPoints = 0;
      let pendingCount = 0;
      let awaitingCount = 0;
      let totalCount = data.length;
      if (!data.length) {
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "No tasks yet.";
        list.appendChild(empty);
      }
      data.forEach(t => {
        if (t.status === "approved") {
          myApprovedPoints += t.credit_points || 0;
        }
        if (t.status === "user_completed") {
          awaitingPoints += t.credit_points || 0;
        }
        if (t.status === "pending") pendingCount += 1;
        if (t.status === "user_completed") awaitingCount += 1;
        const li = document.createElement("li");
        li.className = "item";
        const actionButtons = [];
        if (!IS_STAFF && t.status === "pending" && t.assigned_to === CURRENT_USER_ID) {
          actionButtons.push(`<button class="secondary" data-user-complete="${t.id}">Mark completed</button>`);
        }
        if (IS_STAFF && t.status === "user_completed") {
          actionButtons.push(`<button class="secondary" data-approve="${t.id}">Approve</button>`);
        }
        li.innerHTML = `
          <div>
            <div><strong>${t.title}</strong></div>
            <div class="muted">${t.description || ""}</div>
            <div class="muted">Assigned: ${t.assigned_to_username || "-"}</div>
          </div>
          <div style="text-align:right; min-width:160px;">
            <div class="pill ${t.status === "approved" ? "success" : "warn"}">${t.status.replace("_"," ")}</div>
            <div class="muted">Points: ${t.credit_points}</div>
            <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end; flex-wrap:wrap;">
              ${actionButtons.join(" ")}
            </div>
          </div>
        `;
        list.appendChild(li);
      });
      list.querySelectorAll("[data-user-complete]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try {
            await api(`${apiBase}/tasks/${btn.dataset.userComplete}/`, {
              method: "PATCH",
              body: JSON.stringify({ user_notes: "" })
            });
            showToast("Marked as completed");
            await refreshAll();
          } catch (e) { showToast(e.message, true); }
        });
      });
      list.querySelectorAll("[data-approve]").forEach(btn => {
        btn.addEventListener("click", async () => {
          try {
            await api(`${apiBase}/tasks/${btn.dataset.approve}/approve/`, { method: "POST" });
            showToast("Approved");
            await refreshAll();
          } catch (e) { showToast(e.message, true); }
        });
      });
      document.getElementById("stat-tasks").textContent = data.length;
      document.getElementById("stat-points").textContent = myApprovedPoints;
      document.getElementById("dash-total").textContent = totalCount;
      document.getElementById("dash-pending").textContent = pendingCount;
      document.getElementById("dash-awaiting").textContent = awaitingCount;
      document.getElementById("dash-awaiting-points").textContent = awaitingPoints;
      document.getElementById("dash-my-points").textContent = myApprovedPoints;
      document.getElementById("task-total-points").textContent = myApprovedPoints;
    }

    async function loadUserFilter() {
      const select = document.getElementById("user-filter");
      if (!select) return;
      const users = await api(`${apiBase}/users/`);
      users.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.username;
        select.appendChild(opt);
      });
      select.addEventListener("change", () => {
        refreshAll().catch(err => showToast(err.message, true));
      });
    }

    async function refreshAll() {
      await loadTasks();
    }

    (async () => {
      try {
        await loadUserFilter();
        await refreshAll();
      } catch (err) {
        showToast(err.message, true);
      }
    })();
  </script>
</body>
</html>

